---
title: "mod_lengetal"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Script for modifing data from Leng et al. and running it with Cyclone and Seurat

Script reads in the whole matrix of data from Leng et al and only saves the cells (columns) that are annotated according to cell cycle phase. (G1=91, S=80, G2M=76)

The matrix can be downloaded from this link https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE64016. 

```{r load, warning=FALSE}

suppressPackageStartupMessages(library(SummarizedExperiment))
suppressPackageStartupMessages(library(MultiAssayExperiment))

suppressPackageStartupMessages(library(plotrix))
suppressPackageStartupMessages(library(Seurat))
suppressPackageStartupMessages(library(scran))
suppressPackageStartupMessages(library(gridExtra))

```

# This needs to be run in order to run Seurat to get the gene pairs
```{r convert_names}
savefile = "seurat_cc_genes_mouse.Rdata"
if (file.exists(savefile)){
  load(savefile)
}else{

# Load human ensembl attributes
human = biomaRt::useMart("ensembl", dataset = "hsapiens_gene_ensembl")
# Load mouse ensembl attributes
mouse = biomaRt::useMart("ensembl", dataset = "mmusculus_gene_ensembl")

hsa2mmEnsembl <- function(x,mouse,human){
  # Link both datasets and retrieve mouse genes from the human genes
  genes.list = biomaRt::getLDS(attributes = c("hgnc_symbol"), filters = "hgnc_symbol", values = x , mart = human, attributesL = c("mgi_symbol","ensembl_gene_id"), martL = mouse, uniqueRows = T)
  # Get unique names of genes 
  mouse.gene.list <- unique(genes.list[, 3])
  return(mouse.gene.list)
}

# load data from Seurat package
data(cc.genes)
# convert to mouse ensembl IDs
cc.genes.mouse <- lapply(cc.genes, hsa2mmEnsembl, mouse,human)
save(cc.genes.mouse, file=savefile)
}

```


```{r data}
#reading in datafile
lengetal <- read.csv("embryonic_data/GSE64016_H1andFUCCI_normalized_EC.csv", header = TRUE, sep = ",", quote = "\"")

#saving the columns that are labeled (215-461) into new matrix
exprs_an <- lengetal[,c(215:461)]

#adding rownames that are in the first column of the original data
rownames(exprs_an) <- paste(lengetal[,c(1)])

#Writing the labeled data into a csv file
#write.csv(exprs_an,"/Users/Lovisa #Lundeberg/Documents/slutkurs/data/lengetal_annotated.csv")
```

```{r database}
# getting ensembl ids based on the hgnc symbols in the file
library(biomaRt)
mart = useDataset("hsapiens_gene_ensembl", useMart("ensembl"))
ens_id_hum = getBM(filters = "hgnc_symbol", attributes =       c("ensembl_gene_id","hgnc_symbol"), values=rownames(exprs_an), mart = mart)

# removing all genes that lack ensembl id or have multiple ones
ensCount =  table(ens_id_hum$ensembl_gene_id) 
one2one = names(which(ensCount == 1))
ensCount =  table(ens_id_hum$hgnc_symbol) 
one2oneGene = names(which(ensCount == 1))

ens_id_hum =  ens_id_hum[ens_id_hum$ensembl_gene_id %in% one2one, ]
ens_id_hum =  ens_id_hum[ens_id_hum$hgnc_symbol %in% one2oneGene, ]
exprs_an = exprs_an[rownames(exprs_an) %in% ens_id_hum$hgnc_symbol, ]
exprs_an = exprs_an[ens_id_hum$hgnc_symbol, ]


#adding ensembl IDs as the first column in the data, removing NAs in the data
exprs_an <- cbind(ensembl_id=ens_id_hum$ensembl_gene_id,exprs_an)
exprs_an <- na.omit(exprs_an)
```


```{r filter}
# filter out cells with low nDet
nDet <- colSums(exprs_an[,-1]>1)
hist(nDet,n=100)
keep <- which(nDet>4000)

exprs_an <- exprs_an[,keep]
```

#Cyclone only works with ensembl IDs
# ```{r cyclone, warning=F}
#adding ensembl ids as rownames
# exprs_id <- exprs_an[,-1]
# rownames(exprs_id) <- paste(exprs_an[,1]) 

# exprs_id <- data.matrix(exprs_id)
# mmu.pairs <- readRDS(system.file("exdata", "human_cycle_markers.rds", package="scran"))

# set.seed(123)
# sce_leng <- SingleCellExperiment(assays=list(counts = exprs_id, logcounts = # log2(exprs_id+1)))
# cc <- cyclone(sce_leng, pairs=mmu.pairs)
# table(cc$phase)
# ```

# Seurat works with ensembl IDs for mouse data and with hgnc symbols for human data
#```{r seurat}
# exprs_hgnc <- exprs_an[,-1]

# sdata <- CreateSeuratObject(raw.data = exprs_hgnc, min.cells = 3, min.genes = 200,
#     project = "testseurat",is.expr=1,meta.data=NULL)

# sdata <- NormalizeData(sdata)
# sdata <- ScaleData(sdata)
# sdata <- FindVariableGenes(object = sdata, mean.function = ExpMean, dispersion.function = LogVMR, x.low.cutoff = 0.2, x.high.cutoff = 10, y.cutoff = 0.5)


# run PCA
# sdata <- RunPCA(object = sdata, pc.genes = sdata@var.genes, do.print = FALSE)  
# predict cell cycle
# sdata <- CellCycleScoring(sdata, g2m.genes = cc.genes$g2m.genes, s.genes = cc.genes$s.genes)

# table(sdata@meta.data$Phase)

# ```

``{r reCAT}

exprs_sa_id <- data.matrix(exprs_an[,-1])

# Log transforms the data as get_test requires log-transformed data 
exprs_sa_id <- log(exprs_sa_id+1)

dim(exprs_sa_id)

```

# Clears out all genes not present as marker genes

```{r reCAT_preprocess}

source("reCAT_master/R/get_test_exp.R")
exprs_sa_id <- get_test_exp(exprs_sa_id)
dim(exprs_sa_id)
```

# Orders the data using the TSP algorithm

```{r reCAT_order}
source("reCAT_master/R/get_ordIndex.R")
# exprs_sa_id = input matrix, 3 = no. threads used for processing, can be increased on cluster
nthread = 3

ordIndex <- get_ordIndex(exprs_sa_id, nthread)
```

# Get cell-cycle scores using the Bayes-scores & Mean-scores algorithm

```{r reCAT_scores}
source("reCAT_master/R/get_score.R")
score_result <- get_score(t(exprs_sa_id))
score_result$bayes_score
score_result$mean_score
# cat(score_result$bayes_score, file="bayes_score.txt")
# cat(score_result$mean_score, file="mean_score.txt")
```

# Plots the score values 

```{r reCAT_plot_scores}
source("reCAT_master/R/plot.R")
plot_bayes(score_result$bayes_score, ordIndex)
plot_mean(score_result$mean_score, ordIndex)
```

```{r reCAT_rdata}
source("reCAT_master/R/get_rdata.R")
rdata <- get_rdata(score_result, ordIndex)
View(rdata)
```

# Finds the start of the cell-cycle for time-series scoring

```{r reCAT_get_start}
source("reCAT_master/R/get_start.R")
cycle_start = get_start(score_result, ordIndex)
print(cycle_start)
```

```{r reCAT_get_myord}
source("reCAT_master/R/get_myord.R")
myord = get_myord(cycle_start, ordIndex)
```

# Finds the cell cycle phases

```{r reCAT_find_phase}
source("reCAT_master/R/get_hmm.R")
cls_num <- 3
hmm_result <- get_hmm_order(bayes_score = score_result$bayes_score, mean_score = score_result$mean_score, ordIndex = ordIndex, cls_num = cls_num, myord = myord, rdata = rdata)

g1_c = sum(hmm_result == 1)
s_c = sum(hmm_result == 2)
g2m_c = sum(hmm_result == 3)
phase_counts = t(data.frame(g1_c, g2m_c, s_c))
write.table(phase_counts,"recat_phase_output.txt",sep="\t",col.names = FALSE, row.names=FALSE)
View(phase_counts)
```
